---
title: "Vignette for the hancock package"
author:
- name: Kevin Rue-Albrecht
  affiliation:
  - &id1 Kennedy Institute of Rheumatology, University of Oxford, Headington, Oxford OX3 7FY, UK.
  email: kevin.rue-albrecht@kennedy.ox.ac.uk
- name: Second Author
  affiliation: Second Author's Affiliation
  email: corresponding@author.com
date: "`r BiocStyle::doc_date()`"
package: hancock
output: 
  BiocStyle::html_document:
    toc_float: true
abstract: |
  Example usage of the hancock package demonstrated using example data sets.
vignette: |
    %\VignetteIndexEntry{Vignette for the hancock package}
    %\VignetteEncoding{UTF-8}
    %\VignettePackage{hancock}
    %\VignetteKeywords{GeneExpression, RNASeq, Sequencing}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: hancock.bib
---

**Compiled date**: `r Sys.Date()`

**Last edited**: 2018-03-08

**License**: `r packageDescription("hancock")[["License"]]`

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    error = FALSE,
    warning = FALSE,
    message = FALSE
)
```

# Overview

The goal of the `r Githubpkg("kevinrue/hancock")` package is to provide a collection of methods for learning and applying gene signatures associated with cellular phenotypes and identities.
Particular focus is given to single-cell data stored in objects derived from the `r Biocpkg("SummarizedExperiment")` class.

# Getting started

## Setup

To run an analysis, the first step is to start R and load the `r Githubpkg("kevinrue/hancock")` package:

```{r, message=FALSE}
library(hancock)
```

## Example data set

As an initial example, we demonstrate an analysis to find genes markers of three populations of neurons labelled by the fluorescent protein tdTomato (tdT) after Cre-mediated recombination.

For this example, we use a subset of single cell RNA-seq dataset from the Allen Brain Atlas [@tasic2016].
This dataset is available in the `r Biocpkg("scRNAseq")` Experiment data package:

```{r}
library(scRNAseq)
data(allen)
allen
```

The individual Cre line is indicated for each cell in the `"driver_1_s"` metadata.

```{r}
table(allen$driver_1_s)
```

## Learning signatures

The learning method `"PositiveProportionDifference"` requires prior clustering information to be stored as a `factor` in a column of the `colData` slot.
The method can then be applied to identify markers for each cluster, using a variety of filters on individual markers (e.g., minimal difference in detection rate between clusters) and on the combined set of markers (e.g., minimal proportion of samples in the target cluster where all markers are detected simultaneously).

```{r}
allen$driver_1_s <- as.factor(allen$driver_1_s)
baseset <- learnSignatures(
    se = allen, assay.type = "tophat_counts", method = "PositiveProportionDifference",
    cluster.col = "driver_1_s", min.diff = 0.3, min.prop = 0.5, diff.method = "min")
relations(baseset)
```

## Applying signatures to predict labels

The markers identified above may then be applied on the training data set itself, to annotate each cluster with its corresponding signature.

```{r}
allen.hancock <- predict(
    baseset, allen, assay.type = "tophat_counts", method = "ProportionPositive",
    cluster.col="driver_1_s")
allen.hancock
```

In particular, the `predict` function populates:

- the `"hancock"` column of `colData(allen.hancock)`
- the `"hancock"` item of `metadata(allen.hancock)`

```{r}
summary(as.data.frame(colData(allen.hancock)[["hancock"]]))
metadata(allen.hancock)[["hancock"]]
```

Similarly, the same markers may be applied to other data sets.

## Renaming signatures

### Manually

Renaming a set of signatures is as simple as renaming the levels of the `factor` that stores the signature names.

```{r}
setIds(baseset) <- gsub("_", " ", setIds(baseset))
table(ids(sets(baseset)))
```

## Interactively

In addition, the `r Githubpkg("kevinrue/hancock")` package includes a lightweight `r CRANpkg("shiny")` app that offers users the possibility to interactively rename signatures while inspecting their features in a `SummarizedExperiment` object (e.g., count of samples associated with each signature, layout in reduced dimension).

Specifically, the app requires a set of signatures and a `SummarizedExperiment` object that was previously annotated with those signatures using the `predict` function.
When closed, the app returns the updated set of signatures.

```{r}
allen.hancock <- predict(
    baseset, allen, assay.type = "tophat_counts", method = "ProportionPositive",
    cluster.col="driver_1_s")
if (interactive()) {
    library(shiny)
    allen.hancock <- runApp(shinyLabels(baseset, allen.hancock))
}
```

Notably, this `r CRANpkg("shiny")` app automatically detects the presence of optional dimensionality reduction results in `r Biocpkg("SingleCellExperiment")` objects, allowing inspection and annotation of the gene signatures using that information.

```{r}
library(SingleCellExperiment)
library(scater)
allen.hancock <- as(allen.hancock, "SingleCellExperiment")
allen.hancock <- normalize(allen.hancock, exprs_values="tophat_counts")
allen.hancock <- runPCA(allen.hancock)
allen.hancock <- runTSNE(allen.hancock)
if (interactive()) {
    library(shiny)
    allen.hancock <- runApp(shinyLabels(baseset, allen.hancock))
}
```

# Types of signatures

## Absolute markers

As described in the accompanying [concepts](concepts.html) vignette, absolute markers may be defined as genes detected in each cluster, irrespective of their expression in the other clusters.

For instance, the `"PositiveProportionDifference"` learning method can be used to identify such markers, by setting `min.diff=0` to annul any comparison between the detection frequency in the target cluster and all other clusters.

As the numbers of genes detected in each cluster may be rather large, it is generally a good idea to restrict markers to be detected in a very high fraction of the corresponding cluster, for instance `min.prop = 0.9`.
In addition, the `threshold` argument may be used to define a minimal threshold of expression level to consider a marker as "detected" in each sample.

This ensures that for each cluster, the combined set of markers is simultaneously detected in at least 90% of cells in that cluster.

```{r}
baseset <- learnSignatures(
    se = allen, assay.type = "rsem_tpm", method = "PositiveProportionDifference",
    cluster.col = "driver_1_s", min.diff = 0, min.prop = 0.9, threshold = 1)
table(ids(sets(baseset)))
relations(baseset)
```

## Relative markers

As described in the accompanying [concepts](concepts.html) vignette, relative markers may be defined by _differential_ analysis against other cells in the same sample.

For instance, the `"PositiveProportionDifference"` learning method can be used to identify such markers, by setting `min.diff` to a value greater than 0, in order to subset candidate markers to those detected at a rate at least 50% higher than the detection rate observed in any other cluster.

```{r}
baseset <- learnSignatures(
    se = allen, assay.type = "tophat_counts", method = "PositiveProportionDifference",
    cluster.col = "driver_1_s", min.diff = 0.5, diff.method = "min")
table(ids(sets(baseset)))
```

Information on each relation between a marker gene and the associated set may be stored as relation metadata accessible using the `relations` method.
Notably, this view highlights how `"minDifferenceProportion"` reflects the `min.diff=0.5` threshold applied when learning the signatures.

```{r}
relations(baseset)
```

Information about individual markers may be stored as element metadata accessible using the `elementData` and `mcols` methods as shown below.
For instance, the proportion of cells positive for each marker across the entire data set.

```{r}
mcols(elementData(baseset))
```

Similarly, information about individual sets may be stored as set metadata accessible using the `setData` and `mcols` methods as shown below.
For instance, the proportion of samples simultaneously positive for all markers in the cluster where this signature was defined.

```{r}
mcols(setData(baseset))
```

For instance, other methods to identify absolute markers could include differential expression between the target cluster and all other clusters to identify candidate markers significantly differentially expressed between clusters.

# Additional information

Bug reports can be posted as issues in the `r Githubpkg("kevinrue/hancock")` GitHub repository.
The GitHub repository is the primary source for development versions of the package, where new functionality is added over time.
The authors appreciate well-considered suggestions for improvements or new features, or even better, pull requests.

If you use `r Githubpkg("kevinrue/hancock")` for your analysis, please cite it as shown below:

```{r citation}
citation("hancock")
```

# Session Info {.unnumbered}

```{r sessioninfo}
sessionInfo()
# devtools::session_info()
```

# References {.unnumbered}
